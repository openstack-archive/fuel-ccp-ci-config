#
# Configurable repository sources
#
- scm:
    name: openstack
    scm:
      - git:
         url: 'https://git.openstack.org/openstack/{scm-repo}.git'
         branches:
          - '{scm-branch}'
         basedir: '{scm-basedir}'

- scm:
    name: fuel-infra
    scm:
      - git:
          url: 'ssh://nextgen-ci@review.fuel-infra.org:29418/{scm-repo}.git'
          basedir: '{scm-basedir}'
          skip-tag: true
          branches:
            - '{scm-branch}'

#
# Repository source with gerrit changes
#
- scm:
    name: fuel-infra_trigger
    scm:
      - git:
          basedir: '{scm-basedir}'
          branches:
            - $GERRIT_BRANCH
          remotes:
            - gerrit:
                refspec: $GERRIT_REFSPEC
                url: 'ssh://nextgen-ci@review.fuel-infra.org:29418/$ZUUL_PROJECT'
          choosing-strategy: gerrit

- trigger:
    name: fuel-infra
    triggers:
      - gerrit:
          trigger-on:
            - patchset-created-event
            - comment-added-contains-event:
                comment-contains-value: 'recheck'
          projects:
            - project-compare-type: PLAIN
              project-pattern: '{project-pattern}'
              branches:
                - branch-compare-type: ANT
                  branch-pattern: '**'
          custom-url: '* $JOB_NAME $BUILD_URL'

- trigger:
    name: fuel-infra-no-vote
    triggers:
      - gerrit:
          trigger-on:
            - patchset-created-event
            - comment-added-contains-event:
                comment-contains-value: 'recheck'
          projects:
            - project-compare-type: PLAIN
              project-pattern: '{project-pattern}'
              branches:
                - branch-compare-type: ANT
                  branch-pattern: '**'
          custom-url: '* $JOB_NAME $BUILD_URL'
          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true

- trigger:
    name: fuel-infra-patchset-merged
    triggers:
      - gerrit:
          trigger-on:
            - change-merged-event
          projects:
            - project-compare-type: PLAIN
              project-pattern: '{project-pattern}'
              branches:
                - branch-compare-type: ANT
                  branch-pattern: '**'
          custom-url: '* $JOB_NAME $BUILD_URL'

#
# Static repositories
#


#
# SSH credentials
#
- wrapper:
    name: nextgen-ci-jenkins
    wrappers:
      - ssh-agent-credentials:
          users:
            - '77acc946-f346-4665-8271-c141b6ae9764'
            - '04a7dbe6-f3cd-4cc1-afc5-b8f2bd6cbb38'

#
# Publishers
#
- publisher:
    name: logs-public
    publishers:
      - ssh:
          site: 'ci-logs.fuel-infra.org'
          target: 'kolla-ci/$JOB_NAME/$BUILD_ID'
          source: 'logs/*'
          flatten: true

- publisher:
    name: logs-private
    publishers:
      - archive:
          allow-empty: true
          artifacts: 'logs/*'
          latest-only: false

#
# Builders
#
- builder:
    name: check-tox
    builders:
      - shell: 'tox -v -e {tox-test}'
