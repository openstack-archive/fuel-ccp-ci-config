- job-template:
    name: fuel-ccp-{component}-{version}-deployment
    description: |
      Deploy CCP and run basic OpenStack tests (uses snapshot for K8s cluster)
    node: standard
    builders:
      - zuul-clone
      - inject:
          properties-content: |
            COMPONENT={component}
            VERSION={version}
      - shell:
          !include-raw-escape 'builders/fuel-ccp-simple-deployment.sh'
    publishers:
      - post-tasks:
          - matches:
              - log-text: ''
            escalate-status: false
            run-if-job-successful: false
            script: |
              #!/bin/bash

              set -ex
              ENV_NAME="fuel-ccp-{component}-{version}-deployment"
              FUEL_DEVOPS_SNAPSHOT_NAME="fresh"
              FUEL_DEVOPS_INSTALLATION_DIR="/home/jenkins/venv-fuel-devops-3.0"
              source "$FUEL_DEVOPS_INSTALLATION_DIR"/bin/activate
              echo "Running on $NODE_NAME: $ENV_NAME"
              virsh list --all
              dos.py revert "$ENV_NAME" "$FUEL_DEVOPS_SNAPSHOT_NAME"
              dos.py destroy "$ENV_NAME"
              deactivate
    concurrent: true
    properties:
      - heavy-job:
          weight: 2
      - throttle:
          option: project
          max-per-node: 1
      - least-load:
          disabled: False
    scm:
      - openstack:
          scm-basedir: 'fuel-ccp'
          scm-branch: 'master'
          scm-repo: 'fuel-ccp'
      - openstack:
          scm-basedir: 'fuel-ccp-installer'
          scm-branch: 'master'
          scm-repo: 'fuel-ccp-installer'
    wrappers:
      - ng-cleanup
      - fuel-ccp-ci-jenkins
      - timeout:
          timeout: 120
          fail: true

- project:
    name: Deploy CCP and run basic OpenStack tests (uses snapshot for K8s cluster)
    version:
      - master
      - newton
    component:
      - smoke
      - full
      - debian-base
      - etcd
      - mariadb
      - memcached
      - rabbitmq
      - stacklight
      - cinder
      - galera
      - glance
      - heat
      - horizon
      - ironic
      - keystone
      - murano
      - neutron
      - nova
      - openstack-base
      - sahara
    jobs:
      - 'fuel-ccp-{component}-{version}-deployment'
